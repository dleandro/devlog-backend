name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

jobs:
  # Job 1: Code Quality (Formatting and Linting)
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25.1"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-code-quality-${{ hashFiles('**/go.sum') }}-${{ hashFiles('**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-code-quality-
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Check formatting
        run: make fmt-check

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.6.0

      - name: Run linter
        run: make lint

  # Job 2: Build
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25.1"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}-${{ hashFiles('**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-build-
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Build application
        run: make build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbl-blog-backend-${{ github.sha }}
          path: dbl-blog-backend
          retention-days: 7

  # Job 3: Unit and Integration Tests
  unit-tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25.1"

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-unit-tests-${{ hashFiles('**/go.sum') }}-${{ hashFiles('**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-unit-tests-
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run unit and integration tests
        run: make test

  # Job 4: E2E Tests (Full Docker Environment)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test environment file
        run: |
          cat > .env << EOF
          # E2E Test Environment
          MONGODB_USERNAME=testuser
          MONGODB_PASSWORD=testpass123
          MONGODB_AUTH_SOURCE=admin
          DB_NAME=dbl_blog_e2e
          ADMIN_API_KEYS=e2e-test-key-1,e2e-test-key-2,e2e-test-key-3
          ENABLE_PUBLIC_RATE_LIMIT=false
          PORT=8080
          EOF

      - name: Run E2E tests with Docker
        run: make test-e2e-docker

      - name: Collect Docker logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Services ==="
          docker compose ps
          echo "=== MongoDB Logs ==="
          docker compose logs mongodb
          echo "=== Blog API Logs ==="
          docker compose logs blog-api
          echo "=== E2E Tests Logs ==="
          docker compose logs e2e-tests

      - name: Cleanup Docker resources
        if: always()
        run: docker compose down -v

  # Job 5: Security Scan (Optional)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    continue-on-error: true # Don't fail the entire pipeline on security issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25.1"

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: ./...

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.sha }}
          path: gosec-report.json
          retention-days: 30
        if: always()
